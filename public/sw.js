// Single Service Worker - Clean offline-first implementation
importScripts('https://storage.googleapis.com/workbox-cdn/releases/6.5.4/workbox-sw.js');

const CACHE_VERSION = 'v1.1.0';
const CACHE_NAMES = {
  pages: `pages-${CACHE_VERSION}`,
  staticAssets: `static-assets-${CACHE_VERSION}`,
  nextStatic: `next-static-${CACHE_VERSION}`,
  apis: `apis-${CACHE_VERSION}`
};

if (workbox) {
  workbox.setConfig({ debug: false });

  // Inject precache manifest (generated by workbox-build)
[{"revision":"8c96f43dcbfcb6681f5319f508c3e16c","url":"static/chunks/turbopack-03103b90177291b1.js"},{"revision":"5458632ee5cb3da028baebb11d5f70dd","url":"static/chunks/ff1a16fafef87110.js"},{"revision":"09cbd13322f78cf0233188a3226d8d7f","url":"static/chunks/f4f6458daf9ee802.js"},{"revision":"a755e1a9d4daf6a7c93b4b5e90b752a0","url":"static/chunks/efb9a5f6a9ebb912.js"},{"revision":"242ad748b7ef8a20ab57b930104d6623","url":"static/chunks/d3d2e12e47ed7ab9.js"},{"revision":"baf4c95778006ea1a8d23f98ceb413ac","url":"static/chunks/cc759f7c2413b7ff.js"},{"revision":"a091ee6af88bfe4858d824dd4520cf1b","url":"static/chunks/cadf9700ebad3b4a.js"},{"revision":"2bd4fa8669a3b3285dbf93df38516be2","url":"static/chunks/c35d5c22a9ef8588.js"},{"revision":"846118c33b2c0e922d7b3a7676f81f6f","url":"static/chunks/a6dad97d9634a72d.js"},{"revision":"099f1b08dd2edfb92b5a8cbf4fd98022","url":"static/chunks/a5617f9b3e13bac0.js"},{"revision":"6c6d02f8411ef77e7e1d9cd13e3a3285","url":"static/chunks/85ad22f805faa017.js"},{"revision":"04994d93025829776454ff5902b297cf","url":"static/chunks/7d2a55b2359115a1.js"},{"revision":"a71fe16b655e39d3fd2199aea7a49814","url":"static/chunks/7d1725ff2ad98bc0.js"},{"revision":"fc8bc5e8a41c3eb7415f6f7d8a3c1f32","url":"static/chunks/75d7b26df1c890cc.js"},{"revision":"07116caaa974183af6252904a1e19581","url":"static/chunks/7340adf74ff47ec0.js"},{"revision":"41bcadfae0522a4b12f3e6d93b117c09","url":"static/chunks/715606b882972e7c.js"},{"revision":"dd22071f35de5a272689c153b8a25364","url":"static/chunks/4efb09b6a089f7b3.js"},{"revision":"46a5743094c657408a7652a6d728c66f","url":"static/chunks/4d5f42c9224f8c17.js"},{"revision":"99d926937f86fe4a9609d9ff1b954dee","url":"static/chunks/17bb38bff44521fb.js"},{"revision":"e1532c6bb8f4da4183c5a932ecd57865","url":"static/chunks/0a24da26285862d5.js"},{"revision":"6f6ba05d7cfd987444512f9beab69ff3","url":"static/chunks/06c84d225246a435.js"},{"revision":"77797f3b45637e93b9a6d081aaeb2b6b","url":"static/chunks/0342f2c1c07a5398.js"},{"revision":"fdcced9bead204a047bcbd54e061e31f","url":"static/chunks/492d5101aa89c264.css"}]
  // Install event - service worker installation
  self.addEventListener('install', (event) => {
    console.log('üöÄ Service Worker installing');
    event.waitUntil(
      caches.open(CACHE_NAMES.pages).then(cache => {
        console.log('üì¶ Precaching start URL /');
        return cache.add('/');
      })
    );
    self.skipWaiting();
  });

  // Activate event - clean up old caches and take control
  self.addEventListener('activate', (event) => {
    console.log('üéØ Service Worker activating');
    event.waitUntil(
      Promise.all([
        // Clean up old caches
        caches.keys().then(cacheNames => {
          return Promise.all(
            cacheNames.map(cacheName => {
              if (!Object.values(CACHE_NAMES).includes(cacheName)) {
                console.log('üóëÔ∏è Deleting old cache:', cacheName);
                return caches.delete(cacheName);
              }
            })
          );
        }),
        // Take control of all clients
        self.clients.claim()
      ])
    );
  });

  // Message handling for updates
  self.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'SKIP_WAITING') {
      self.skipWaiting();
    }
  });

  // CRITICAL: Start URL "/" - NetworkFirst, NO offline.html fallback
  // Essential for PWA cold-start - must always attempt to load the app
  workbox.routing.registerRoute(
    ({ request, url }) => request.mode === 'navigate' && url.pathname === '/',
    new workbox.strategies.NetworkFirst({
      cacheName: CACHE_NAMES.pages,
      networkTimeoutSeconds: 3,
    })
  );

  // Other navigation pages - NetworkFirst, WITH offline.html fallback
  // For pages not cached, show offline.html instead of breaking
  workbox.routing.registerRoute(
    ({ request, url }) => request.mode === 'navigate' && url.pathname !== '/',
    new workbox.strategies.NetworkFirst({
      cacheName: CACHE_NAMES.pages,
      networkTimeoutSeconds: 3,
      plugins: [
        new workbox.cacheableResponse.CacheableResponsePlugin({
          statuses: [0, 200]
        }),
        new workbox.expiration.ExpirationPlugin({
          maxEntries: 50,
          maxAgeSeconds: 24 * 60 * 60
        }),
        // ‚úÖ Fallback to offline.html for non-start navigation
        {
          handlerDidError: async () => {
            const cache = await caches.open(CACHE_NAMES.pages);
            const offlineResponse = await cache.match('/offline.html');
            return offlineResponse || new Response('Offline page not available', { status: 503 });
          }
        }
      ]
    })
  );

  // Document requests (not navigation) - NetworkFirst with offline.html fallback
  // For images/documents opened outside PWA, direct fetch requests, etc.
  workbox.routing.registerRoute(
    ({ request }) => request.destination === 'document' && request.mode !== 'navigate',
    new workbox.strategies.NetworkFirst({
      cacheName: CACHE_NAMES.pages,
      networkTimeoutSeconds: 3,
      plugins: [
        new workbox.cacheableResponse.CacheableResponsePlugin({
          statuses: [0, 200]
        }),
        new workbox.expiration.ExpirationPlugin({
          maxEntries: 50,
          maxAgeSeconds: 24 * 60 * 60
        }),
        // ‚úÖ Fallback to offline.html for document requests (not navigation)
        {
          handlerDidError: async () => {
            const cache = await caches.open(CACHE_NAMES.pages);
            const offlineResponse = await cache.match('/offline.html');
            return offlineResponse || new Response('Offline page not available', { status: 503 });
          }
        }
      ]
    })
  );

  // Cache static assets aggressively (images, icons, etc.)
  workbox.routing.registerRoute(
    /\.(?:png|jpg|jpeg|svg|gif|webp|ico|woff|woff2|ttf|eot)$/,
    new workbox.strategies.CacheFirst({
      cacheName: CACHE_NAMES.staticAssets,
      plugins: [
        new workbox.expiration.ExpirationPlugin({
          maxEntries: 100,
          maxAgeSeconds: 30 * 24 * 60 * 60 // 30 days
        })
      ]
    })
  );

  // Cache Next.js static files (JS/CSS chunks)
  workbox.routing.registerRoute(
    /\/_next\/static.+\.(?:js|css)$/,
    new workbox.strategies.CacheFirst({
      cacheName: CACHE_NAMES.nextStatic,
      plugins: [
        new workbox.expiration.ExpirationPlugin({
          maxEntries: 200,
          maxAgeSeconds: 7 * 24 * 60 * 60 // 7 days
        })
      ]
    })
  );

  // API routes - NetworkFirst with timeout
  workbox.routing.registerRoute(
    ({ url }) => url.origin === self.location.origin && url.pathname.startsWith('/api/'),
    new workbox.strategies.NetworkFirst({
      cacheName: CACHE_NAMES.apis,
      networkTimeoutSeconds: 10,
      plugins: [
        new workbox.expiration.ExpirationPlugin({
          maxEntries: 16,
          maxAgeSeconds: 24 * 60 * 60 // 24 hours
        })
      ]
    })
  );

  console.log('‚úÖ Service Worker loaded successfully -', CACHE_VERSION);
} else {
  console.error('‚ùå Workbox failed to load');
}
